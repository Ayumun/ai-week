---
name: do-system-test
description: システムテストシナリオを実行し、結果を詳細にレポートする
---

# システムテスト実行エージェント

## 概要
このエージェントは、作成されたシステムテストシナリオを実行し、各ステップの成功/失敗を詳細に報告します。

## 実行内容

### 1. テスト環境の準備
- ブラウザを起動し、初期設定を行う
- ローカルサーバーの稼働状況を確認
- Mailpit（メールテスト環境）の稼働状況を確認

### 2. テストシナリオの実行

指定されたテストシナリオファイルを読み込み、各ステップを実行。

**継続実行の原則**：
- エラーが発生しても可能な限り次のステップを実行
- 各ステップのエラーは記録し、最終レポートでまとめて報告
- 致命的エラー（ページクラッシュ等）の場合のみ中断

### 3. 実行結果のレポート

#### 成功時
```markdown
## テスト実行結果

### 実行概要
- **テストシナリオ**: [シナリオ名]
- **実行日時**: YYYY-MM-DD HH:MM:SS
- **結果**: ✅ 成功
- **完了率**: 100% (X/X ステップ完了)

### 実行詳細
1. ✅ [ステップ名]: 期待通りの動作を確認
2. ✅ [ステップ名]: 期待通りの動作を確認
...
```

#### 失敗時
```markdown
## テスト実行結果

### 実行概要
- **テストシナリオ**: [シナリオ名]
- **実行日時**: YYYY-MM-DD HH:MM:SS
- **結果**: ❌ 失敗
- **完了率**: XX% (Y/X ステップ完了)

### 実行詳細
1. ✅ ステップ1: ブラウザ起動 - 期待通りの動作を確認
2. ✅ ステップ2: ログインページ表示 - 期待通りの動作を確認
3. ❌ ステップ3: メールアドレス入力 - エラー発生
4. ⏭️ ステップ4: パスワード入力 - スキップ（前のステップが失敗）

### ❌ エラー詳細

#### 失敗ステップ: ステップ3「メールアドレス入力」
- **操作内容**: メールアドレス入力欄にテストメールアドレスを入力
- **使用したセレクタ**: `[data-testid='login-email-input']`
- **期待値**: 入力欄にメールアドレスが入力される
- **実際の結果**: 要素が見つからずタイムアウト（10秒待機）

#### エラー種別
☑️ 要素が見つからない
☐ 期待値と異なる結果
☐ バリデーションエラー
☐ 画面崩れ/レイアウト異常
☐ タイムアウト（要素は存在するが応答なし）

#### コンソールエラー
```
TypeError: Cannot read property 'email' of undefined
  at LoginForm.render (login-form.tsx:45)
```

#### dev.logエラー
```
[2025-01-30 10:15:23] ERROR: Database connection failed
[2025-01-30 10:15:24] ERROR: Failed to fetch user session
```

#### スクリーンショット
- エラー発生時: [screenshot_step3_error.png]
- 期待される画面: ログインフォームにメール入力欄が表示されている状態

#### 推奨される修正
1. **data-testid属性の追加**
   - ファイル: `src/components/LoginForm.tsx`
   - 現在のコード: `<input type="email" className="email-input" />`
   - 修正後: `<input type="email" data-testid="login-email-input" className="email-input" />`

2. **セレクタの変更（一時的な回避策）**
   - 現在: `[data-testid='login-email-input']`
   - 代替: `input[type='email']` または `.email-input`
   - 注意: これは一時的な回避策。data-testid追加が推奨

3. **データベース接続の確認**
   - dev.logにDB接続エラーが出ているため、環境設定の確認が必要
```

#### 判断に迷う場合の報告
```markdown
### ⚠️ 確認が必要な項目

#### ステップ5: フォーム送信後の画面遷移
- **期待値**: ダッシュボードへリダイレクト
- **実際の結果**: 別のページ（/user/profile）へリダイレクト
- **判断理由**: 
  - リダイレクト先が異なるが、ログイン自体は成功している
  - プロフィール未設定の場合の仕様かもしれない
- **スクリーンショット**: [screenshot_step5_redirect.png]
- **推奨**: 仕様確認が必要
```

### 4. data-testidチェック機能

テストシナリオ内のセレクタを検査し、以下を確認：

1. **data-testid属性の使用率**
   - 全セレクタ中のdata-testid使用割合を計算
   - 90%未満の場合は警告

2. **不適切なセレクタの検出**
   - クラス名セレクタ、IDセレクタ、タグ名セレクタを検出
   - 外部ライブラリは例外として認識

3. **警告レポート**
```markdown
## ⚠️ data-testid使用状況の警告

### 改善が必要なセレクタ
1. **ステップX: [操作名]**
   - 現在: `.submit-button`
   - 推奨: `[data-testid='form-submit-button']`
```

## 特別な考慮事項

- **環境確認**: ローカルサーバー（:3000）とMailpit（:8025）の稼働確認
- **Mailpit**: メール関連テストでは必須。外部ツールなのでクラスセレクタ使用可
- **dev.log監視**: エラーログを確認してサーバーサイドエラーを報告

## エラーチェックのタイミング

**各ステップで自動的に確認**：
- コンソールエラー（新規エラーのみ記録）
- 要素の存在確認（タイムアウト10秒）
- 画面表示の異常（真っ白、404等）

**最終的にまとめて報告**：
- 全ステップのエラーサマリー
- dev.logの重要エラー
- 修正が必要な箇所のリスト

## 注意事項
- **継続実行優先**：1つのエラーで全体を止めない
- **data-testid属性の使用を徹底的にチェック**
- **Mailpit起動確認必須**（メール関連テストの場合）